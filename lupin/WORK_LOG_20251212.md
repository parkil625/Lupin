# 작업 로그 - 2025년 12월 12일

## 작업 브랜치
- `appointmentAndChat`

## 발견된 오류

### 1. 채팅방 클릭 시 메시지 전환 안됨
**증상**:
- 의사 페이지에서 다른 채팅방을 클릭해도 이전 채팅 내용이 그대로 남아있음
- 새로운 채팅방의 메시지가 이전 메시지 위에 추가되는 현상

**원인**:
- `DoctorChatPage.tsx`의 `onClick` 핸들러에서 `setSelectedChatMember`만 호출
- 메시지 상태(`messages`)를 초기화하지 않음
- `useEffect`에서 새 메시지를 로드하기 전까지 이전 메시지가 화면에 표시됨

**해결**:
```typescript
// Before
onClick={() => setSelectedChatMember({ ... })}

// After
onClick={() => {
  setMessages([]);  // 이전 메시지 즉시 초기화
  setSelectedChatMember({ ... });
}}
```

**파일**: `src/components/dashboard/chat/DoctorChatPage.tsx:283-296`
**커밋**: `241f9b6`

---

### 2. 읽지 않은 메시지 개수(unreadCount)가 0으로 업데이트 안됨
**증상**:
- 채팅방을 클릭하여 메시지를 읽어도 빨간 뱃지의 숫자가 그대로 유지됨
- `markAsRead` API는 정상 호출되지만 UI에 반영되지 않음

**원인**:
- `markAsRead` 호출 후 채팅방 목록을 다시 불러오지 않음
- 서버에서는 읽음 처리가 되었지만 클라이언트 상태가 갱신되지 않음

**해결**:
```typescript
await chatApi.markAsRead(roomId, currentUserId);
console.log('✅ 읽음 처리 완료:', roomId);
// 읽음 처리 후 채팅방 목록 다시 로드 (unreadCount 갱신)
await loadChatRooms();
```

**파일**: `src/components/dashboard/chat/DoctorChatPage.tsx:145-148`
**커밋**: `241f9b6`

---

### 3. 마지막 메시지 시간이 실시간으로 갱신 안됨
**증상**:
- 새 메시지를 받아도 대화 목록의 "오후 2:14" 같은 시간이 업데이트되지 않음
- 첫 메시지 "test" 이후 추가 메시지를 보내도 시간이 그대로 유지됨

**원인**:
- 메시지 수신 시 `handleMessageReceived`에서 메시지 상태만 업데이트
- 채팅방 목록(`chatRooms`)은 갱신하지 않아 `lastMessageTime`이 변경되지 않음

**해결**:
```typescript
const handleMessageReceived = useCallback(
  (message: ChatMessageResponse) => {
    setMessages((prev) => [...prev, message]);
    if (message.senderId !== currentUserId) {
      toast.success("새 메시지가 도착했습니다");
    }
    // 메시지 수신 시 채팅방 목록 갱신 (최신 메시지 시간 및 내용 업데이트)
    loadChatRooms();
  },
  [currentUserId, loadChatRooms]
);
```

**파일**: `src/components/dashboard/chat/DoctorChatPage.tsx:94-104`
**커밋**: `241f9b6`

---

### 4. 대화 목록 정렬이 실시간으로 적용 안됨
**증상**:
- 새 메시지를 받아도 해당 채팅방이 맨 위로 올라오지 않음
- 카카오톡처럼 최신 대화가 맨 위에 표시되어야 하는데 고정됨

**원인**:
- `loadChatRooms` 함수가 `useEffect` 내부에 정의되어 재사용 불가능
- 메시지 수신/읽음 처리 시 채팅방 목록을 갱신할 방법이 없음

**해결**:
```typescript
// loadChatRooms를 useCallback으로 분리하여 재사용 가능하게 변경
const loadChatRooms = useCallback(async () => {
  try {
    const rooms = await chatApi.getChatRooms(currentUserId);
    // 최신 메시지 순서대로 정렬 (카톡처럼)
    const sortedRooms = rooms.sort((a: ChatRoomResponse, b: ChatRoomResponse) => {
      const timeA = a.lastMessageTime ? new Date(a.lastMessageTime).getTime() : 0;
      const timeB = b.lastMessageTime ? new Date(b.lastMessageTime).getTime() : 0;
      return timeB - timeA; // 최신순
    });
    setChatRooms(sortedRooms);
  } catch (error) {
    console.error("채팅방 목록 로드 실패:", error);
  }
}, [currentUserId]);
```

**파일**: `src/components/dashboard/chat/DoctorChatPage.tsx:73-86`
**커밋**: `241f9b6`

---

### 5. 환자 이름이 "알 수 없음"으로 표시 (미해결)
**증상**:
- 의사 대화 목록에서 일부 채팅방의 환자 이름이 "알 수 없음"으로 표시됨
- 실제로는 "테스트유저" 등의 이름이 있어야 함

**원인 추정**:
- 백엔드 `ChatController.java:74-84`에서 예약 정보를 찾을 수 없을 때 기본값 반환
- DB에 예약 데이터가 없거나 roomId 형식이 맞지 않을 가능성

**현재 상태**:
```java
try {
    Appointment appointment = chatService.getAppointmentFromRoomId(roomId);
    room.put("patientId", appointment.getPatient().getId());
    room.put("patientName", appointment.getPatient().getName());
    room.put("doctorId", appointment.getDoctor().getId());
} catch (Exception e) {
    log.warn("채팅방 {}에 대한 예약 정보를 찾을 수 없습니다", roomId);
    room.put("patientId", 0);
    room.put("patientName", "알 수 없음");  // ← 여기서 발생
    room.put("doctorId", userId);
}
```

**추가 조사 필요**:
- DB에 실제 예약 데이터가 올바르게 있는지 확인
- roomId 형식이 `appointment_{id}` 형식을 따르는지 확인
- `getAppointmentFromRoomId` 메서드에서 예외가 발생하는 원인 로그 확인

**파일**: `src/main/java/com/example/demo/controller/ChatController.java:74-84`

---

## 개선 사항

### 1. 실시간 채팅방 갱신 (이벤트 기반)
**Before**: 폴링 방식이나 수동 새로고침 필요
**After**:
- 메시지 송신 시 자동 갱신
- 메시지 수신 시 자동 갱신
- 읽음 처리 시 자동 갱신

**장점**:
- 서버 부하 감소 (폴링 제거)
- 즉각적인 UI 반영
- 사용자 경험 향상

---

### 2. 카카오톡 스타일 UX
**구현**:
- 최신 메시지가 맨 위로 자동 정렬
- 오늘 메시지: 시간만 표시 (오후 3:45)
- 과거 메시지: 날짜 표시 (12월 11일)
- 읽지 않은 메시지 빨간 뱃지

**코드**:
```typescript
const formatChatTime = (timeString?: string) => {
  if (!timeString) return "";

  const messageTime = new Date(timeString);
  const today = new Date();
  const isToday = messageTime.toDateString() === today.toDateString();

  if (isToday) {
    return messageTime.toLocaleTimeString("ko-KR", {
      hour: "numeric",
      minute: "2-digit",
      hour12: true,
    });
  } else {
    return messageTime.toLocaleDateString("ko-KR", {
      month: "long",
      day: "numeric",
    });
  }
};
```

**파일**: `src/components/dashboard/chat/DoctorChatPage.tsx:41-64`

---

### 3. 채팅방 전환 시 깔끔한 메시지 초기화
**Before**: 이전 메시지 + 새 메시지가 섞여서 표시
**After**:
1. 채팅방 클릭
2. 즉시 메시지 화면 초기화 (빈 화면)
3. 새 채팅방 메시지 로드 및 표시

**사용자 경험**:
- 어떤 채팅방을 보고 있는지 명확히 구분 가능
- 메시지 로딩 상태가 시각적으로 명확함
- 혼란 방지

---

## 기술적 세부사항

### React Hooks 사용
1. **useCallback**: `loadChatRooms` 함수 메모이제이션
   - 의존성: `[currentUserId]`
   - 목적: 여러 곳에서 재사용, 불필요한 재생성 방지

2. **useEffect 체인**:
   - 초기 로드: `loadChatRooms()` 호출
   - roomId 변경 감지: 새 메시지 로드
   - 연결 및 선택 감지: 읽음 처리 + 목록 갱신

### 상태 관리 흐름
```
메시지 수신 → handleMessageReceived
            → setMessages (메시지 추가)
            → loadChatRooms (목록 갱신)
            → setChatRooms (정렬된 목록)
            → UI 리렌더링

채팅방 클릭 → setMessages([]) (초기화)
           → setSelectedChatMember
           → useEffect 감지
           → loadMessages (새 메시지 로드)
           → markAsRead (읽음 처리)
           → loadChatRooms (목록 갱신)
```

---

## 테스트 결과

### 프론트엔드 빌드
```bash
npm run build
✓ built in 8.83s
```
✅ 컴파일 에러 없음

### 백엔드 테스트
- AppointmentServiceTest: 별도 실행 필요 (환영 메시지 제거 반영됨)

---

## 다음 단계 (권장)

### 1. "알 수 없음" 문제 디버깅
- 백엔드 로그 확인: `log.warn("채팅방 {}에 대한 예약 정보를 찾을 수 없습니다", roomId);`
- DB 쿼리 실행:
  ```sql
  SELECT * FROM appointments WHERE id = {appointmentId};
  SELECT * FROM users WHERE id IN (patient_id, doctor_id);
  ```
- roomId 형식 검증: WebSocket 로그에서 실제 전송되는 roomId 확인

### 2. 환영 메시지 관련 정리
- 커밋 `076ae57`: AppointmentService에서 환영 메시지 제거
- 커밋 `81454a0`: AppointmentServiceTest에서 saveMessage 검증 제거
- 확인 사항: 실제 환영 메시지가 더 이상 생성되지 않는지 통합 테스트 필요

### 3. 프로덕션 배포
- 현재 로컬 브랜치: `appointmentAndChat`
- 메인 브랜치 머지 필요 시: PR 생성 후 리뷰
- 배포 전 체크리스트:
  - [ ] 백엔드 테스트 전체 통과
  - [ ] 프론트엔드 빌드 성공
  - [ ] "알 수 없음" 문제 해결 확인
  - [ ] 실제 환경에서 채팅 기능 E2E 테스트

---

## 커밋 히스토리
```
241f9b6 - doctor 페이지 대화목록창 상호작용 개선
9b6e9b9 - fix: DoctorChatPage sort 콜백에 타입 명시
4d48ca7 - fix: FeedRepository에 List import 추가
81edc79 - feat: HoverCard에 department 및 activeDays 표시 기능 추가
```

---

## 관련 이슈 (이전 세션)
1. Doctor ID 매핑 불일치 → 해결 (DB 데이터 기준 22-25로 변경)
2. roomId 형식 불일치 (`13:22` vs `appointment_10`) → 해결 (`appointment_{id}` 통일)
3. COMPLETED 예약 필터링 → 해결 (CANCELLED만 제외)
4. 채팅방 스크롤바 → 해결 (Tailwind scrollbar 클래스 추가)
